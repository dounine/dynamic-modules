<!DOCTYPE HTML>
<HTML xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>dynamic-modules</title>
    <script src="/common/jquery/dist/jquery.min.js"></script>
    <script src="/common/angular/angular.min.js"></script>
    <script src="/common/angular-ui-router/release/angular-ui-router.js"></script>
    <script src="/common/oclazyload/dist/ocLazyLoad.js"></script>
</head>
<body>
<div ng-app="myApp" ng-controller="indexCtrl">
    <div ui-view></div>
    <input ng-model="username"/>
    你的名字{{username}}
</div>
<script>
    var app = angular.module('myApp', ['ui.router', 'oc.lazyLoad']);
    app.controller('indexCtrl', function ($scope, $rootScope, $urlRouter, $ocLazyLoad, $location) {
        $scope.username = "hello"

        $rootScope.$on('$locationChangeSuccess', function () {
            if (!$location.path()) {
                $location.path('/index');
            }
            $ocLazyLoad.load($location.path() + "/js/config.js").then(function () {
                $ocLazyLoad.load($location.path() + "/js/router.js").then(function () {
                    $urlRouter.sync();
                });
            });
//            $ocLazyLoad.load($location.path() + "/js/router.js").then(function () {
//                $urlRouter.sync();
//            });
        });
    })
    ;
    app.run(['$rootScope', function ($rootScope) {
//        console.info('run')
    }]);
    app.config(['$provide', '$urlRouterProvider', function ($provide, $urlRouterProvider) {
        $urlRouterProvider.deferIntercept();
        $provide.decorator('$state', function ($delegate, $ocLazyLoad) {
            var state = {};
            angular.copy($delegate, state);
            $delegate.transitionTo = function (uiRouter) {
                if (uiRouter.self) {
                    console.info(uiRouter.self.url)
                    $ocLazyLoad.load([uiRouter.self.url + '/js/controller.js']).then(function () {
                        state.transitionTo.apply(null, [uiRouter.self.url.substring(1)]);
                    });
                } else {
                    $ocLazyLoad.load('/user/app/js/rev/controller.js').then(function () {
                        state.transitionTo.apply(null, arguments);
                    });
                }
            }
            return $delegate;
        });

    }]);
</script>
</body>
</html>
